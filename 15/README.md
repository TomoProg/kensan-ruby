# 今週のテーマ
データベースが鍵を握る

# 方針
Railsにおけるデータベース設計のベストプラクティスが学べたら嬉しい。
全体をざっと読んでみる

## 15.1 なぜそんなにもデータベース設計が重要なのか
データの方がアプリケーションコードよりも価値がある
アプリケーションは変化していくが、データは変化しない。アプリケーションより寿命が長い。


## 15.2 採用するデータベースを決める
### データベースの種類
#### リレーショナルデータベース
割愛

#### ドキュメントデータベース
JSON形式に代表される階層構造をもったデータを格納できる。
JSONをそのまま格納可能。RDBでいうテーブル定義を決めなくても、JSONをそのまま格納できる。
```text
[
  {
    "学籍番号": "10003",
    "基本情報": { "名前":"佐藤", "性別": "男" },
    "趣味" : [ "映画", "音楽", "ドライブ" ]
  },
  {
    "学籍番号": "10003",
    "基本情報": { "名前":"鈴木", "年齢": 20, "出身": "埼玉" },
    "テスト結果": { "英語": 80, "国語": 70 }
  },
  ...
]
```

- 主な製品

MongoDB  
CouchDB

#### キーバリューストア型データベース（KVS）
キーに対して値を一つだけ持つ、もしくは複数持つことができるデータベース。
RDBのようにテーブルを定義したりはせず、自由に値を保持できる

- 主な製品

Redis

#### グラフデータベース
TODO

#### 参考
- RDBエンジニアのための10分でわかるDocumentDB  
https://www.nttpc.co.jp/technology/documentdb.html
- key-value データベースとは?  
https://aws.amazon.com/jp/nosql/key-value/


> リレーショナルデータベースを採用するとして、プロダクトの選択肢はいろいろあります。  
> オープンソースのデータベースを選ぶなら、ほとんどのアプリケーションにとって最善の選択肢は PostgreSQL です。
> PostgreSQL は、オープンソースのデータベースのなかでは抜群に堅牢で、先進的なデータ型やインデックスへの対応も進んでいます。
> MySQL でもうまくやっていくことは可能ですが、いつの間にかデータが消 失することがないように、細心の注意を払って MySQL を設定する必要があります。

感覚だが、Postgresの方が何かと最新機能が取り入れられるし、SQL標準への対応も進んでいるイメージ
いつの間にかデータが消失することがないようにというのはよくわからなかった。
Postgresだとデータ消失の可能性が低いのだろうか？

PostgresとMySQLの比較とかやってみたい。

## 15.3 最も重要なデータベース設計の原則
- それぞれの行は、単一または組み合わせたカラムから一意に参照できる(つまり、必ず主キーがある)

- それぞれのカラムには、単一の値を格納する。値のコレクションは格納しない  
  つまり、一つの属性に複数持つのではなく、行ごとに持たせろ

- それぞれのカラムには、他のカラムとは異なる種類のデータを格納する  
  つまり、これも列持ちではなく、行持ちにしろ

- テーブルの各カラムは主キーにのみ依存する。他のカラムには依存しない
  つまり第3正規形まで持っていけ

## 15.3.1 データベースの非正規化を検討する
実行性能の最適化を行う場合は非正規化を検討するが、必要だという確証がある場合のみとする

## 15.3.2 その他のデータベース設計原則
- テーブルをなるべく小さくする（不要なカラムを持たない）
- インデックスはデータへのアクセス方法を検討してから追加する
- 外部キー制約は可能であれば常に適用する

## 15.4 データベースは単なるデータ置き場ではない
- データベースで完結させられるならデータベースで完結させた方が実行性能の改善になる
- 可能な限りデータベースの制約を使う
  - NOT NULL 制約
  - CHECK 制約
  - UNIQUE 制約（部分UNIQUE制約というのもあるらしい）  
    ちなみにユニーク制約とユニークインデックスは違うものらしい。詳しく調べてみたい。
- 複数のテーブルをまたいで一貫性を強制するにはトリガーを使う

Postgresには部分インデックスなるものがあるらしい

## 15.5 モデル層を選ぶ
- ActiveRecord
- Sequel
が有名

## 15.6 データベースとモデルのエラー処理
一般原則として、データベースアクセス関連のエラーはできる限り早い段階で捕捉すべき。  
実際にデータベースに対してクエリを発行する前に問題を検出できるのが理想。  
変なデータ突っ込まれるのが一番困るしそうだよね。  

> Active Record では、モデルのカラムごとに手動でバリデーションを定義して、データベース制約は使わないことが推奨されています。

そうなのか？確かにCHECK制約は書いたことないけど・・・  
ユニークインデックスやNOT NULL制約、外部キー制約とかは普通に使ってる。  
